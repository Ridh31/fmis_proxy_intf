<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/img/logo-fmis-v2-300x190-1.png" rel="shortcut icon">
    <script src="/datatables/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="/datatables/jquery.dataTables.min.css">
    <script src="/datatables/jquery.dataTables.min.js"></script>
    <script src="/jquery-ui/jquery-ui.min.js"></script>
    <title>{{title}}</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background-color: #F6F8FA;
            margin: 0;
            padding: 2rem;
        }

        h2 {
            color: #A45617;
            font-size: 1.3rem;
            margin-top: 0;
            margin-bottom: 1rem;
        }

        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .input-title {
            color: #CCC;
            font-size: 12px;
        }

        input, button {
            padding: 0.6rem 1rem;
            border-radius: 5px;
            border: 1px solid #E4E4E4;
            font-size: 14px;
        }

        button {
            background-color: #1A73E8;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #0F5CC2;
        }

        .table-container {
            padding: 1.5rem;
            background-color: #FFFFFF;
            border-radius: 7px;
            border: 1px solid #E4E4E4;
            margin-top: 1rem;
            overflow-x: auto;
        }

        #logTable {
            border: 1px solid #E4E4E4;
            font-size: 14px;
        }

        .dataTable tbody tr.odd {
            background-color: #FFFFFF;
        }

        .dataTable tbody tr.even {
            background-color: #F0F2F5;
        }

        table.dataTable thead > tr > th {
            font-weight: 600;
        }

        .dataTables_length, .dataTables_filter {
            margin-bottom: 1rem;
        }

        .dataTables_paginate {
            margin-top: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #FFFFFF;
            border-radius: 2px;
            font-size: 14px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
        }

        th {
            background-color: #F1F3F5;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #F0F2F5;
        }

        tr:hover {
            background-color: #EEF2F7;
        }

        .success {
            color: #2E7D32;
            font-weight: 500;
        }

        .error {
            color: #C62828;
            font-weight: 500;
        }

        .view-link {
            color: #1A73E8;
            cursor: pointer;
        }

        .view-link:hover {
            color: #E88C1A;
        }

        .modal {
            overflow: auto;
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 0.2rem;
            right: 1rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 2rem;
            color: #8B8B8B;
            z-index: 10;
        }

        #modalTitle {
            margin-top: 0;
            font-size: 1.25rem;
            color: #A45617;
            user-select: none;
        }

        #modalBody {
            overflow-y: auto;
            flex: 1;
            padding-right: 0.5rem;
        }

        .credentials {
            display: none;
        }
    </style>
</head>
<body>
<h2>{{heading}}</h2>
<div class="filter-bar">
    <label>
        <span class="input-title">BANK ACCOUNT NUMBER</span><br>
        <input id="bankAccount" type="text" placeholder="e.g. 0000-00-123456-7N" title="Enter bank account number">
    </label>
    <label>
        <span class="input-title">STATEMENT DATE</span><br>
        <input id="statementDate" type="date" title="Select statement date">
    </label>
    <label>
        <span class="input-title">IMPORTED DATE</span><br>
        <input id="importedDate" type="date" title="Select import date">
    </label>
    <label>
        <span class="input-title"></span><br>
        <button onclick="fetchData()">Filter</button>
    </label>
</div>

<div class="table-container">
    <table id="logTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Bank Account</th>
                <th>Statement Date</th>
                <th>Status</th>
                <th>Method</th>
                <th>Endpoint</th>
                <th>Imported By</th>
                <th>Imported Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal" id="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Statement Records</h2>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<div class="credentials">
    <div data-username="{{username}}"></div>
    <div data-password="{{password}}"></div>
    <div data-partner-token="{{partnerToken}}"></div>
</div>

<script>
    const username = document.querySelector('[data-username]')?.dataset.username;
    const password = document.querySelector('[data-password]')?.dataset.password;
    const partnerToken = document.querySelector('[data-partner-token]').dataset.partnerToken;
    const basicAuth = btoa(`${username}:${password}`);
    const baseUrl = window.location.origin;
    const url = `${baseUrl}/api/v1/list-bank-statement`;

    let fullData = [];
    let modalContent = $(".modal-content");

    // Draggable Modal
    $(() => {
        modalContent.draggable({
            handle: ".modal-header",
            cursor: "move"
        });
    });

    /**
     * Displays a loading message in the table body while data is being fetched.
     */
    function showLoading() {
        const tbody = document.querySelector("#logTable tbody");
        tbody.innerHTML = "";

        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 9;
        cell.style.textAlign = "center";
        cell.style.margin = "0.75rem";
        cell.style.fontWeight = "bold";
        cell.innerText = "Loading...";
        row.appendChild(cell);
        tbody.appendChild(row);
    }

    /**
     * Removes the loading message row from the table body if present.
     */
    function hideLoading() {
        const tbody = document.querySelector("#logTable tbody");
        const rows = tbody.querySelectorAll("tr");

        rows.forEach(row => {
            if (row.textContent.trim() === "Loading...") {
                tbody.removeChild(row);
            }
        });
    }

    /**
     * Fetches paginated bank statement data from the API based on filter inputs,
     * aggregates all pages, and updates the table display.
     * Handles loading state, authorization headers, and errors gracefully.
     */
    async function fetchData() {
        const tbody = document.querySelector("#logTable tbody");
        tbody.innerHTML = "";
        showLoading();

        const account = document.getElementById('bankAccount').value;
        const statementDate = document.getElementById('statementDate').value;
        const importedDate = document.getElementById('importedDate').value;

        const params = new URLSearchParams();
        params.append("size", 100);
        if (account) params.append("bankAccountNumber", account);
        if (statementDate) params.append("statementDate", formatDate(statementDate));
        if (importedDate) params.append("importedDate", formatDate(importedDate));

        try {
            let allData = [];
            let currentPage = 0;
            let totalPages = 1;

            while (currentPage < totalPages) {
                params.set("page", currentPage);

                const response = await fetch(`${url}?${params.toString()}`, {
                    headers: {
                        'Authorization': `Basic ${basicAuth}`,
                        'X-Partner-Token': partnerToken
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                const responseList = data?.data?.content || [];
                allData = allData.concat(responseList);

                totalPages = data?.data?.totalPages || 1;
                currentPage++;
            }

            fullData = allData;
            renderTable();

        } catch (err) {
            console.error("Fetch failed:", err);
            tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; color: red;">Error fetching data.</td></tr>`;
        } finally {
            hideLoading();
        }
    }

    /**
     * Formats a date string into DD-MM-YYYY format.
     * @param {string} input - The input date string.
     * @returns {string} Formatted date as 'DD-MM-YYYY'.
     */
    function formatDate(input) {
        const d = new Date(input);
        return `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
    }

    /**
     * Renders the DataTable for bank statement logs.
     * Destroys any existing instance, then initializes a new one
     * using `fullData`, sets columns, pagination, and action handlers.
     */
    function renderTable() {
        let bankStatementDataTable = $('#logTable');

        if ($.fn.DataTable.isDataTable('#logTable')) {
            bankStatementDataTable.DataTable().destroy();
        }

        bankStatementDataTable.DataTable({
            data: fullData.map((item, i) => [
                i + 1,
                item.bankAccountNumber,
                item.statementDate,
                `<span class="${item.status === 'Processed' ? 'success' : 'error'}">${item.status}</span>`,
                item.method,
                item.endpoint,
                item.importedBy || 'N/A',
                item.createdDate || 'N/A',
                `<span class="view-link" data-index='${i}' onclick="handleViewClick(this)">View</span>`
            ]),
            columns: [
                { title: "#" },
                { title: "Bank Account" },
                { title: "Statement Date" },
                { title: "Status" },
                { title: "Method" },
                { title: "Endpoint" },
                { title: "Imported By" },
                { title: "Imported Date" },
                { title: "Action" }
            ],
            pageLength: 10,
            lengthMenu: [10, 25, 50, 100],
            destroy: true
        });
    }

    /**
     * Opens the modal and displays the statement data JSON prettily
     * @param {object} item - The statement data object
     */
    function openModal(item) {
        const modal = document.getElementById("modal");
        const body = document.getElementById("modalBody");

        const message = typeof item.message === "string" ? item.message : "";

        // Get the specific Entry number
        let highlightedIndex = -1;
        const entryMatch = message.match(/Entry:\s*(\d+)/);
        if (entryMatch) {
            highlightedIndex = parseInt(entryMatch[1], 10) - 1;
        }

        // Extract error fields
        const fieldsToHighlight = new Set();
        const fieldMatch = message.match(/CMB_[A-Z_]+/g);
        if (fieldMatch) {
            fieldMatch.forEach(f => fieldsToHighlight.add(f));
        }

        let html = "";

        if (item.Data && Array.isArray(item.Data.CMB_BANKSTM_STG)) {
            const isGlobalError = message && message.includes('Entry: *');
            const showGlobalDetailsBox = isGlobalError;
            const showSpecificDetailsBox = message && Number.isInteger(highlightedIndex);
            const shownDetailBox = new Set();
            const isStatus = item.status === "Processed";

            // 1. Show global error message ONCE at the top
            if (showGlobalDetailsBox && !isStatus) {
                html += `<div style="background-color: #FFF3CD; color: #856404; border: 1px solid #FFEEBA; border-radius: 8px; font-size: 0.85rem; padding: 0.75rem; margin-bottom: 1rem;">
                    <strong>Details: </strong>${message}
                </div>`;
            } else if (isStatus) {
                html += `<div style="background-color: #D4EDDA; color: #155724; border: 1px solid #C3E6CB; border-radius: 8px; font-size: 0.85rem; padding: 0.75rem; margin-bottom: 1rem;">
                    <strong>Details: </strong>${message}
                </div>`;
            }

            // 2. Loop through each entry
            item.Data.CMB_BANKSTM_STG.forEach((entry, i) => {
                const isErrorEntry = i === highlightedIndex;
                const showThisDetailsBox = showSpecificDetailsBox && isErrorEntry && !shownDetailBox.has(i);
                const isHighlighted = isGlobalError || isErrorEntry;

                html += `<div style="margin-bottom: 1rem;">`;

                // 2a. Show specific error above the relevant entry
                if (showThisDetailsBox) {
                    html += `<div style="background-color: #FFF3CD; color: #856404; border: 1px solid #FFEEBA; border-radius: 8px; font-size: 0.85rem; padding: 0.75rem; margin-bottom: 1rem;">
                        <strong>Details: </strong>${message}
                    </div>`;
                    shownDetailBox.add(i);
                }

                // Container
                html += `<div style="
                    padding:1rem;
                    margin-bottom:1rem;
                    border-radius:8px;
                    font-size:0.85rem;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    border: 1px solid ${isHighlighted ? '#F5C6CB' : '#E4E4E4'};
                    background-color:${isHighlighted ? '#FCEBEA' : '#F9F9F9'};
                    color: ${isHighlighted ? '#842029' : 'inherit'};
                ">`;

                // Badge
                html += `
                <div style="display: flex; justify-content: flex-start;">
                    <span style="
                        background-color: ${isHighlighted ? '#E6A8A1' : '#B0B0B0'};
                        color: white;
                        padding: 4px 7px;
                        border-radius: 5px;
                        font-size: 0.75rem;
                        font-weight: 600;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    ">
                        Entry ${i + 1}
                    </span>
                </div>`;

                Object.entries(entry).forEach(([key, value]) => {
                    const isFieldError = isErrorEntry && fieldsToHighlight.has(key);
                    html += `
                    <p style="margin: 4px 0; ${isFieldError ? 'border-left: 4px solid #D9534F; padding-left: 8px; background-color: #FEF7F7;' : ''}">
                        <span style="font-weight: 600;">${key}:</span>
                        <span style="color: ${isHighlighted ? '#B97A78' : '#8C7F77'};"> ${value}</span>
                    </p>`;
                });

                html += `</div>`;
                html += `</div>`;
            });

        } else {
            html += `<pre style="white-space: pre-wrap; font-size: 0.85rem;">${JSON.stringify(item, null, 2)}</pre>`;
        }

        body.innerHTML = html;
        modal.style.display = "flex";
    }

    /**
     * Closes the modal.
     */
    function closeModal() {
        document.getElementById("modal").style.display = "none";
    }

    /**
     * Handles the "View" action click by retrieving the data item and opening its details in a modal.
     */
    function handleViewClick(el) {
        const index = el.getAttribute("data-index");
        const item = fullData[index];
        openModal(item);
    }

    // Initial fetch when page loads
    fetchData();
</script>
</body>
</html>